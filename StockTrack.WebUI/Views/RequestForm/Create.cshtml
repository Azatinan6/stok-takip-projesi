@using StockTrack.Dto.RequestForm
@using StockTrack.WebUI.Enums
@model CreateRequestFormDto

@{
    ViewData["Title"] = "Yeni Talep";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
    </div>
}

<div class="row">
    <div class="col-lg-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light"><h4 class="card-title mb-0"><i class="mdi mdi-clipboard-text-outline me-2"></i>Ürün Talep Formu</h4></div>
            <div class="card-body">
                <form asp-action="Create" method="post" id="requestWizardForm">
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="ItemsJson" id="ItemsJson" />
                    <div id="personsHiddenContainer"></div>

                    <ul class="wizard-nav mb-5">
                        <li class="wizard-list-item">
                            <div class="list-item active">
                                <div class="step-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Lokasyon & Depo">
                                    <i class="bx bx-buildings"></i>
                                </div>
                            </div>
                        </li>
                        <li class="wizard-list-item">
                            <div class="list-item">
                                <div class="step-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Ürün Seçimi">
                                    <i class="bx bx-package"></i>
                                </div>
                            </div>
                        </li>
                        <li class="wizard-list-item">
                            <div class="list-item">
                                <div class="step-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Özet & Tür">
                                    <i class="bx bx-check-circle"></i>
                                </div>
                            </div>
                        </li>
                    </ul>

                    <div class="wizard-tab" data-step="1" style="display:block">
                        <div class="text-center mb-4">
                            <h5>Lokasyon & Depo</h5>
                            <p class="card-title-desc text-muted">Önce işlem yapılacak lokasyonu ve çıkış yapılacak depoyu seçin.</p>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label for="LocationId" class="form-label">Lokasyon <span class="text-danger">*</span></label>
                                    <select id="LocationId" name="LocationId" class="form-select" asp-items="@(ViewBag.Locations as List<SelectListItem>)">
                                        <option value="">-- Seçiniz --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label for="MainRepoId" class="form-label">Depo <span class="text-danger">*</span></label>
                                    <select id="MainRepoId" name="MainRepoId" class="form-select" asp-items="@(ViewBag.MainRepos as List<SelectListItem>)">
                                        <option value="">-- Seçiniz --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="step1Warn" class="alert alert-warning d-none shadow-sm">
                            <i class="mdi mdi-alert-circle-outline me-2"></i><span></span>
                        </div>
                    </div>

                    <div class="wizard-tab" data-step="2" style="display:none">
                        <div class="text-center mb-4">
                            <h5>Kategori & Ürün Seçimi</h5>
                            <p class="card-title-desc text-muted">Gönderilecek veya iade alınacak ürünleri ve detaylarını belirleyin.</p>
                        </div>

                        <div class="row">
                            <div class="col-lg-5">
                                <div class="mb-3 border p-2 rounded bg-light">
                                    <label class="form-label d-block mb-1">İşlem Türü <span class="text-danger">*</span></label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="OperationType" id="opSend" value="1" checked>
                                        <label class="form-check-label text-success fw-bold" for="opSend"><i class="mdi mdi-arrow-up-bold"></i> Gönderilecek</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="OperationType" id="opReturn" value="2">
                                        <label class="form-check-label text-danger fw-bold" for="opReturn"><i class="mdi mdi-arrow-down-bold"></i> İade Beklenen</label>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label for="CategoryId" class="form-label">Kategori</label>
                                        <select id="CategoryId" class="form-select">
                                            <option value="">Önce depo seçiniz</option>
                                        </select>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label for="ProductId" class="form-label">Ürün</label>
                                        <select id="ProductId" class="form-select">
                                            <option value="">Önce kategori seçiniz</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label for="ReasonId" class="form-label">Neden <span class="text-danger">*</span></label>
                                        <select id="ReasonId" class="form-select">
                                            <option value="">Seçiniz</option>
                                            <option value="Arıza / Bozuk">Arıza / Bozuk</option>
                                            <option value="Yeni Kurulum">Yeni Kurulum</option>
                                            <option value="Yedek Parça">Yedek Parça</option>
                                        </select>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label for="AddQty" class="form-label">Miktar</label>
                                        <input type="number" id="AddQty" class="form-control" min="1" placeholder="Miktar">
                                        <small class="text-muted">Stok: <span id="RemainingStock" class="fw-bold text-primary">-</span></small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="LabelInput" class="form-label">Etiket (Cihaz İsimleri vb.)</label>
                                    <input type="text" id="LabelInput" class="form-control" placeholder="Örn: 1. Kat Monitörü">
                                </div>

                                <div id="addWarn" class="alert alert-warning d-none shadow-sm">
                                    <i class="mdi mdi-alert-circle-outline me-1"></i><span></span>
                                </div>

                                <div class="d-flex align-items-center gap-2 mt-2">
                                    <button type="button" id="btnAddProduct" class="btn btn-primary px-4 shadow-sm">
                                        <i class="mdi mdi-plus"></i> Ekle
                                    </button>

                                    <button type="button" id="btnConfigArcBox" class="btn btn-warning shadow-sm d-none" data-bs-toggle="modal" data-bs-target="#arcBoxConfigModal">
                                        <i class="mdi mdi-cog-outline"></i> Config Gir (Arc Box)
                                    </button>
                                </div>
                            </div>

                            <div class="col-lg-7 mt-4 mt-lg-0">
                                <div class="card border border-success mb-3 shadow-sm">
                                    <div class="card-header bg-success bg-soft text-success fw-bold py-2">
                                        <i class="mdi mdi-arrow-up-bold"></i> Gönderilecek Ürünler
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                            <table class="table table-sm table-hover mb-0" id="sendItemsTable">
                                                <thead class="table-light text-muted small" style="position: sticky; top: 0; z-index: 1;">
                                                    <tr>
                                                        <th>Ürün</th>
                                                        <th>Kat.</th>
                                                        <th>Adet</th>
                                                        <th>Neden</th>
                                                        <th>Etiket</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border border-danger shadow-sm">
                                    <div class="card-header bg-danger bg-soft text-danger fw-bold py-2">
                                        <i class="mdi mdi-arrow-down-bold"></i> İade Beklenen Ürünler
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                            <table class="table table-sm table-hover mb-0" id="returnItemsTable">
                                                <thead class="table-light text-muted small" style="position: sticky; top: 0; z-index: 1;">
                                                    <tr>
                                                        <th>Ürün</th>
                                                        <th>Kat.</th>
                                                        <th>Adet</th>
                                                        <th>Neden</th>
                                                        <th>Etiket</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div id="listWarn" class="alert alert-warning d-none mt-2"><span></span></div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-tab" data-step="3" style="display:none">
                        <div class="text-center mb-4">
                            <h5>Özet ve Ek Seçenekler</h5>
                            <p class="card-title-desc text-muted">Seçimlerinizi kontrol edin, talep türünü ve ek seçenekleri belirleyin.</p>
                        </div>

                        <div class="row mb-4">
                            <div class="col-lg-6">
                                <div class="card border shadow-sm">
                                    <div class="card-header bg-light"><strong><i class="mdi mdi-map-marker me-1"></i> Lokasyon & Depo</strong></div>
                                    <div class="card-body">
                                        <div class="mb-1"><strong>Lokasyon:</strong> <span id="sumLocation">-</span></div>
                                        <div><strong>Depo:</strong> <span id="sumRepo">-</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card border shadow-sm">
                                    <div class="card-header bg-light"><strong><i class="mdi mdi-package-variant-closed me-1"></i> Ürün Özeti</strong></div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm mb-0" id="sumItemsTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Tür</th>
                                                        <th>Ürün</th>
                                                        <th>Kategori</th>
                                                        <th class="text-end">Miktar</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <fieldset class="mb-4 border p-3 rounded bg-light">
                            <legend class="fs-6 fw-bold w-auto px-2">Talep Türü</legend>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="TypeId" id="typeKargo" value="@((int)EnumRequestType.Kargo)">
                                <label class="form-check-label" for="typeKargo">Kargo</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="TypeId" id="typeKurulum" value="@((int)EnumRequestType.Kurulum)">
                                <label class="form-check-label" for="typeKurulum">Kurulum</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="TypeId" id="typeServis" value="@((int)EnumRequestType.Servis)">
                                <label class="form-check-label" for="typeServis">Servis</label>
                            </div>
                        </fieldset>

                        <div id="cargoFields" class="d-none">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ReceiverFullName" class="form-label">Alıcı Adı Soyadı <span class="text-danger">*</span></label>
                                    <input type="text" id="ReceiverFullName" name="ReceiverFullName" class="form-control" placeholder="Ad Soyad">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="ReceiverPhone" class="form-label">Telefon Numarası <span class="text-danger">*</span></label>
                                    <input type="tel" id="ReceiverPhone" name="Phone" class="form-control" placeholder="05xx xxx xx xx" pattern="^0[5-9][0-9]{9}$" maxlength="11">
                                </div>
                            </div>
                        </div>

                        <div id="installationFields" class="d-none">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="InstallationDate" class="form-label">Tarih <span class="text-danger">*</span></label>
                                    <input type="date" id="InstallationDate" name="InstallationDate" class="form-control">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-2">
                                        <label for="PersonId" class="form-label">Personel Seç</label>
                                        <select id="PersonId" class="form-select" asp-items="@(ViewBag.Persons as List<SelectListItem>)">
                                            <option value="">Seçiniz</option>
                                        </select>
                                    </div>
                                    <div id="userAddWarn" class="alert alert-warning d-none py-1 px-2 small"><span></span></div>
                                    <button type="button" id="btnAddPerson" class="btn btn-outline-primary btn-sm mt-1">Ekle</button>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <h6 class="mb-0">Eklenen Personeller</h6>
                                        <small class="text-muted" id="totalUsersInfo">0 kullanıcı</small>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered align-middle" id="selectedUsersTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:70%">Ad Soyad</th>
                                                    <th style="width:30%" class="text-center">İşlem</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <div id="userListWarn" class="alert alert-warning d-none py-1 px-2 small"><span></span></div>
                                </div>
                            </div>
                            <div class="mb-3 mt-3">
                                <label for="Note" class="form-label">Not</label>
                                <textarea id="Note" name="Note" class="form-control" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="border p-3 rounded mt-3 bg-light">
                            <strong class="d-block mb-2">Ek Seçenekler</strong>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="IsShipAfterReturn" name="IsShipAfterReturn" value="true">
                                <label class="form-check-label" for="IsShipAfterReturn">İade Ürünler Geldiği Zaman Kargolanacak</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="IsOfficeDelivery" name="IsOfficeDelivery" value="true">
                                <label class="form-check-label" for="IsOfficeDelivery">Ofisten Teslim Edilecek</label>
                            </div>
                        </div>

                        <div id="step3Warn" class="alert alert-warning d-none mt-3"><span></span></div>
                    </div>

                    <div class="d-flex align-items-center mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-secondary w-sm shadow-sm" id="prevBtn"><i class="mdi mdi-arrow-left"></i> Geri</button>
                        <button type="button" class="btn btn-primary w-sm ms-auto shadow-sm" id="nextBtn">İleri <i class="mdi mdi-arrow-right"></i></button>
                        <button type="submit" class="btn btn-success w-sm ms-auto d-none shadow-sm" id="finishBtn"><i class="mdi mdi-check-all"></i> Talebi Tamamla</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="arcBoxConfigModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark"><i class="mdi mdi-cog"></i> Arc Box Configürasyonu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 small">
                    <i class="mdi mdi-information"></i> Son girilen CFG bilgileri yakında buraya otomatik gelecektir.
                </div>

                <div class="mb-3">
                    <label class="form-label">Bağlantı Türü <span class="text-danger">*</span></label>
                    <select id="ConfigConnectionType" class="form-select">
                        <option value="">Seçiniz</option>
                        <option value="Ethernet Statik">Ethernet Statik</option>
                        <option value="Ethernet DHCP">Ethernet DHCP</option>
                        <option value="WIFI Statik">WIFI Statik</option>
                        <option value="WIFI DHCP">WIFI DHCP</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Config URL <span class="text-danger">*</span></label>
                    <input type="text" id="ConfigUrl" class="form-control" placeholder="https://...">
                </div>

                <div class="mb-3" id="divDhcpd">
                    <label class="form-label">dhcpd.conf <span class="text-danger" id="reqDhcpd" style="display:none;">*</span></label>
                    <textarea id="ConfigDhcpd" class="form-control" rows="2" placeholder="Statik IP ayarları..."></textarea>
                </div>

                <div class="mb-3" id="divWpa">
                    <label class="form-label">wpa_supplicant.conf <span class="text-danger" id="reqWpa" style="display:none;">*</span></label>
                    <textarea id="ConfigWpa" class="form-control" rows="2" placeholder="Wifi SSID / Şifre..."></textarea>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" id="btnSaveConfig"><i class="mdi mdi-content-save"></i> Config Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- State ---
        let currentStep = 1;
        const items = [];
        const persons = [];
        let tempArcBoxConfig = null;

        // --- Helpers ---
        function setWarn(divSel, msg) {
            const $d = $(divSel);
            if (!msg) { $d.addClass('d-none'); $d.find('span').text(''); return; }
            $d.removeClass('d-none'); $d.find('span').text(msg);
        }
        function getSelText(sel) {
            const v = $(sel).val();
            if (!v) return null;
            return $(sel).find('option:selected').text();
        }
        function refreshNav() {
            $('.wizard-nav .list-item').removeClass('active');
            $('.wizard-nav .list-item').eq(currentStep - 1).addClass('active');
            $('.wizard-tab').hide();
            $(`.wizard-tab[data-step="${currentStep}"]`).fadeIn(300);
            $('#prevBtn').prop('disabled', currentStep === 1);
            if (currentStep === 3) {
                $('#nextBtn').addClass('d-none');
                $('#finishBtn').removeClass('d-none');
            } else {
                $('#nextBtn').removeClass('d-none');
                $('#finishBtn').addClass('d-none');
            }
        }

        // --- Validations ---
        function step1Valid() {
            const locOk = !!$('#LocationId').val();
            const repoOk = !!$('#MainRepoId').val();
            if (!locOk)  { setWarn('#step1Warn', 'Lütfen lokasyon seçiniz.'); return false; }
            if (!repoOk) { setWarn('#step1Warn', 'Lütfen depo seçiniz.');     return false; }
            setWarn('#step1Warn', null);
            return true;
        }
        function step2Valid() {
            if (items.length === 0) {
                setWarn('#listWarn', 'En az bir ürün eklemelisiniz.');
                return false;
            }
            // Sadece iade varsa ve kargo seçilecekse stok kuralı uygulanmaz, vb. logicler burada genişletilebilir
            setWarn('#listWarn', null);
            return true;
        }

        // --- 3. Aşama Özet Tablosu Doldurma ---
        function step3BindSummary() {
            $('#sumLocation').text(getSelText('#LocationId') ?? '-');
            $('#sumRepo').text(getSelText('#MainRepoId') ?? '-');
            const $tb = $('#sumItemsTable tbody');
            $tb.empty();
            items.forEach(it => {
                let badge = it.operationType === 1
                    ? '<span class="badge bg-success">Gönderim</span>'
                    : '<span class="badge bg-danger">İade</span>';

                $tb.append(
                    `<tr>
                        <td>${badge}</td>
                        <td>${it.productName}</td>
                        <td>${it.categoryName}</td>
                        <td class="text-end fw-bold">${it.quantity}</td>
                    </tr>`
                );
            });
        }

        function serializeItems() {
            $('#ItemsJson').val(JSON.stringify(items));
        }

        function serializePersonsToInputs() {
            const $cont = $('#personsHiddenContainer');
            $cont.empty();
            persons.forEach((p, i) => {
                $cont.append(`<input type="hidden" name="Persons[${i}]" value="${p.id}">`);
            });
        }

        // --- 2. Aşama Tabloları Render (Gönderim & İade) ---
        function renderItemsTable() {
            const $sendTb = $('#sendItemsTable tbody');
            const $returnTb = $('#returnItemsTable tbody');
            $sendTb.empty();
            $returnTb.empty();

            let sendCount = 0;
            let returnCount = 0;

            items.forEach((it, idx) => {
                let configIcon = it.arcBoxConfig ? '<i class="mdi mdi-cog text-warning ms-1" title="Config Girildi" data-bs-toggle="tooltip"></i>' : '';
                let labelText = it.label ? it.label : "-";

                let rowHtml = `<tr data-idx="${idx}">
                        <td>${it.productName} ${configIcon}</td>
                        <td>${it.categoryName}</td>
                        <td class="fw-bold">${it.quantity}</td>
                        <td><small class="text-muted">${it.reason}</small></td>
                        <td><small>${labelText}</small></td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm text-danger btn-remove p-0" title="Sil"><i class="mdi mdi-trash-can-outline font-size-18"></i></button>
                        </td>
                    </tr>`;

                if(it.operationType === 1) {
                    $sendTb.append(rowHtml);
                    sendCount++;
                } else {
                    $returnTb.append(rowHtml);
                    returnCount++;
                }
            });

            if(sendCount === 0) $sendTb.append('<tr><td colspan="6" class="text-center text-muted small py-3">Gönderilecek ürün eklenmedi.</td></tr>');
            if(returnCount === 0) $returnTb.append('<tr><td colspan="6" class="text-center text-muted small py-3">İade beklenecek ürün eklenmedi.</td></tr>');

            // Tooltipleri yenile
            $('[data-bs-toggle="tooltip"]').tooltip();
            serializeItems();
        }

        function renderUsersTable() {
            const $tb = $('#selectedUsersTable tbody');
            $tb.empty();
            persons.forEach((u, idx) => {
                $tb.append(
                    `<tr data-idx="${idx}">
                        <td>${u.name}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger btn-remove-user">Sil</button>
                        </td>
                    </tr>`
                );
            });
            $('#totalUsersInfo').text(`${persons.length} kullanıcı`);
        }

        function clearPersonsUI() {
            persons.length = 0;
            renderUsersTable();
            serializePersonsToInputs();
            setWarn('#userAddWarn', null);
            setWarn('#userListWarn', null);
        }

        // --- Wizard Navigation Buttons ---
        $('#prevBtn').on('click', function () {
            if (currentStep > 1) currentStep--;
            refreshNav();
        });
        $('#nextBtn').on('click', function () {
            if (currentStep === 1) {
                if (!step1Valid()) return;
            } else if (currentStep === 2) {
                if (!step2Valid()) return;
                step3BindSummary();
                serializeItems();
            }
            currentStep++;
            refreshNav();
        });

        // --- Step 1 Events ---
        $('#MainRepoId').on('change', function () {
            $('#CategoryId').empty().append('<option value="">Seçiniz</option>');
            $('#ProductId').empty().append('<option value="">Seçiniz</option>');
            $('#RemainingStock').text('-');
            $('#AddQty').val('').removeAttr('max');

            items.length = 0;
            renderItemsTable();
            serializeItems();

            $('#sumLocation').text('-');
            $('#sumRepo').text('-');
            $('#sumItemsTable tbody').empty();
            $('input[name="TypeId"]').prop('checked', false);
            $('#cargoFields').addClass('d-none');
            $('#installationFields').addClass('d-none');
            $('#InstallationDate').val('');
            $('#Note').val('');
            setWarn('#step3Warn', null);
            setWarn('#listWarn', null);
            setWarn('#addWarn', null);

            clearPersonsUI();

            const repoId = $(this).val();
            if (!repoId) return;

            $.getJSON('@Url.Action("GetCategoriesByRepo", "RequestForm")', { mainRepoId: repoId })
                .done(function (data) {
                    $.each(data, function (i, item) {
                        $('#CategoryId').append($('<option>', { value: item.id, text: item.text }));
                    });
                });
        });

        // --- Step 2 Events ---
        $('#CategoryId').on('change', function () {
            const repoId = $('#MainRepoId').val();
            const catId = $(this).val();
            $('#ProductId').empty().append('<option value="">Seçiniz</option>');
            $('#RemainingStock').text('-');
            $('#AddQty').val('').removeAttr('max');
            setWarn('#addWarn', null);

            if (!repoId || !catId) return;

            $.getJSON('@Url.Action("GetProductsByRepoAndCategory", "RequestForm")',
                { mainRepoId: repoId, categoryId: parseInt(catId) })
                .done(function (data) {
                    $.each(data, function (i, item) {
                        $('#ProductId').append($('<option>', { value: item.id, text: item.text }));
                    });
                });
        });

        // Ürün değişince (Arc Box Kontrolü ve Stok)
        $('#ProductId').on('change', function () {
            const pid = $(this).val();
            const ptext = getSelText('#ProductId') || "";
            const repoId = $('#MainRepoId').val();

            $('#RemainingStock').text('-');
            $('#AddQty').val('').removeAttr('max');
            setWarn('#addWarn', null);
            tempArcBoxConfig = null; // Configi sıfırla

            // Ürün adı "Arc Box" ise Config butonunu göster
            if (ptext.toLowerCase().includes("digitus")) {
                $('#btnConfigArcBox').removeClass('d-none');
                $('#LabelInput').val("-").prop('disabled', true);
            } else {
                $('#btnConfigArcBox').addClass('d-none');
                $('#LabelInput').val("").prop('disabled', false);
            }

            if (!pid) return;

            $.getJSON('@Url.Action("GetProductRemainingStock", "RequestForm")', { productId: pid, mainRepoId: repoId })
                .done(function (d) {
                    const rem = parseInt(d?.remaining ?? 0);
                    $('#RemainingStock').text(rem);
                    $('#AddQty').attr('max', rem > 0 ? rem : 1);
                });
        });

        // Arc Box Config Modal Validation
        $('#ConfigConnectionType').on('change', function() {
            const val = $(this).val();
            if (val === "Ethernet Statik" || val === "WIFI Statik") {
                $('#reqDhcpd').show();
            } else { $('#reqDhcpd').hide(); }

            if (val === "WIFI Statik" || val === "WIFI DHCP") {
                $('#reqWpa').show();
            } else { $('#reqWpa').hide(); }
        });

        // Config Kaydet Butonu
        $('#btnSaveConfig').on('click', function() {
            const connType = $('#ConfigConnectionType').val();
            const url = $('#ConfigUrl').val();
            const dhcpd = $('#ConfigDhcpd').val();
            const wpa = $('#ConfigWpa').val();

            if(!connType || !url) {
                alert("Bağlantı Türü ve Config URL zorunludur!"); return;
            }
            if ((connType === "Ethernet Statik" || connType === "WIFI Statik") && !dhcpd) {
                alert("Statik bağlantılarda dhcpd.conf alanı zorunludur!"); return;
            }
            if ((connType === "WIFI Statik" || connType === "WIFI DHCP") && !wpa) {
                alert("WIFI bağlantılarında wpa_supplicant.conf alanı zorunludur!"); return;
            }

            tempArcBoxConfig = { connectionType: connType, configUrl: url, dhcpdConf: dhcpd, wpaSupplicantConf: wpa };
            $('#arcBoxConfigModal').modal('hide');

            // Alanları temizle
            $('#ConfigConnectionType, #ConfigUrl, #ConfigDhcpd, #ConfigWpa').val('');
        });

        // Ürün Ekle Butonu
        $('#btnAddProduct').on('click', function () {
            const opType = parseInt($('input[name="OperationType"]:checked').val());
            const categoryId = $('#CategoryId').val();
            const categoryName = getSelText('#CategoryId');
            const productId = $('#ProductId').val();
            const productName = getSelText('#ProductId');
            const remaining = parseInt($('#RemainingStock').text());
            const qty = parseInt($('#AddQty').val());
            const reason = getSelText('#ReasonId');
            const reasonId = $('#ReasonId').val(); // Backend'e ID olarak da gidebilir
            const label = $('#LabelInput').val();

            if (!categoryId || !productId || !reasonId) {
                setWarn('#addWarn', 'Kategori, Ürün ve Neden alanlarını seçmelisiniz.'); return;
            }
            if (isNaN(qty) || qty <= 0) {
                setWarn('#addWarn', 'Geçerli bir miktar giriniz.'); return;
            }

            // Eğer GÖNDERİM yapılıyorsa stok kontrolü yapılır (İade ürünü bizde olmadığı için stoğa bakılmaz)
            if (opType === 1) {
                if (isNaN(remaining) || remaining <= 0) {
                    setWarn('#addWarn', 'Bu ürün için depoda kalan stok bulunmuyor.'); return;
                }
                if (qty > remaining) {
                    setWarn('#addWarn', `Maksimum girilebilecek gönderim miktarı ${remaining} adettir.`); return;
                }
            }

            // Arc Box ise config girilmiş mi?
            if (!$('#btnConfigArcBox').hasClass('d-none') && !tempArcBoxConfig) {
                setWarn('#addWarn', 'Lütfen Arc Box için sarı renkli Config butonundan ayarları giriniz.'); return;
            }

            items.push({
                operationType: opType,
                productId: parseInt(productId),
                productName: productName,
                categoryId: parseInt(categoryId),
                categoryName: categoryName,
                quantity: qty,
                reason: reason,
                label: label,
                arcBoxConfig: tempArcBoxConfig
            });

            renderItemsTable();
            setWarn('#addWarn', null);
            $('#AddQty, #ReasonId').val('');
            if(!$('#LabelInput').prop('disabled')) $('#LabelInput').val('');

            // Reset
            tempArcBoxConfig = null;
            $('#btnConfigArcBox').addClass('d-none');
            $('#LabelInput').prop('disabled', false);
        });

        // Tablodan Ürün Silme
        $(document).on('click', '.btn-remove', function () {
            const $tr = $(this).closest('tr');
            const idx = parseInt($tr.data('idx'));
            items.splice(idx, 1);
            renderItemsTable();
        });


        // --- Step 3 Events ---
        $('input[name="TypeId"]').on('change', function () {
            var selectedVal = $(this).val();

            if (selectedVal == '@((int)EnumRequestType.Kurulum)' || selectedVal == '@((int)EnumRequestType.Servis)') {
                $('#installationFields').removeClass('d-none');
                $('#cargoFields').addClass('d-none');
                $('#ReceiverFullName').val('');
            } else if (selectedVal == '@((int)EnumRequestType.Kargo)') {
                $('#cargoFields').removeClass('d-none');
                $('#installationFields').addClass('d-none');
                $('#InstallationDate').val('');
                $('#Note').val('');
                clearPersonsUI();
            }
            setWarn('#step3Warn', null);
        });

        $('#btnAddPerson').on('click', function () {
            const pid = $('#PersonId').val();
            const pname = $('#PersonId option:selected').text();

            if (!pid) { setWarn('#userAddWarn', 'Lütfen bir kullanıcı seçiniz.'); return; }
            if (persons.some(x => x.id == pid)) { setWarn('#userAddWarn', 'Bu kullanıcı zaten eklendi.'); return; }

            persons.push({ id: pid, name: pname });
            setWarn('#userAddWarn', null);
            renderUsersTable();
            serializePersonsToInputs();
        });

        $('#selectedUsersTable').on('click', '.btn-remove-user', function () {
            const idx = parseInt($(this).closest('tr').data('idx'));
            persons.splice(idx, 1);
            renderUsersTable();
            serializePersonsToInputs();
        });

        // --- Submit ---
        $('#requestWizardForm').on('submit', function (e) {
            if (items.length === 0) {
                e.preventDefault();
                currentStep = 2; refreshNav();
                setWarn('#listWarn', 'Talep oluşturabilmek için en az bir ürün eklemelisiniz.');
                return;
            }

            const typeVal = $('input[name="TypeId"]:checked').val();
            if (!typeVal) {
                e.preventDefault();
                setWarn('#step3Warn', 'Lütfen Kargo, Kurulum veya Servis türünden birini seçiniz.');
                return;
            }

            if (typeVal == @((int)EnumRequestType.Kargo)) {
                if (!$('#ReceiverFullName').val()) { e.preventDefault(); setWarn('#step3Warn', 'Kargo için alıcı adı zorunludur.'); return; }
                if (!$('#ReceiverPhone').val()) { e.preventDefault(); setWarn('#step3Warn', 'Kargo için telefon numarası zorunludur.'); return; }
            }

            if ((typeVal == @((int)EnumRequestType.Kurulum) || typeVal == @((int)EnumRequestType.Servis)) && !$('#InstallationDate').val()) {
                e.preventDefault(); setWarn('#step3Warn', 'Kurulum/Servis için tarih zorunludur.'); return;
            }

            if ((typeVal == @((int)EnumRequestType.Kurulum) || typeVal == @((int)EnumRequestType.Servis)) && persons.length === 0) {
                e.preventDefault(); setWarn('#step3Warn', 'Kurulum/Servis için en az bir personel eklemelisiniz.'); return;
            }

            serializeItems();
            serializePersonsToInputs();
        });

        // init
        refreshNav();
        renderItemsTable();
    </script>
}