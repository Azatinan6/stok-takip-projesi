@model CreateUserDto

@{
    ViewData["Title"] = "Kullanıcı Oluşturma";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h2><i class="mdi mdi-account-plus"></i> Kullanıcı Oluştur</h2>

@if (ViewBag.errormesaj != null)
{
    <div class="alert alert-danger">
        @ViewBag.errormesaj
    </div>
}

<form asp-action="CreateUser" method="post" enctype="multipart/form-data">
    <div class="text-bg-danger danger" asp-validation-summary="All"></div>
    <div class="mb-3">
        <label asp-for="NameSurname" class="form-label">Ad Soyad</label>
        <div class="input-group">
            <span class="input-group-text"><i class="mdi mdi-account"></i></span>
            <input asp-for="NameSurname" class="form-control" />
        </div>
        <span asp-validation-for="NameSurname" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ImageUrl" class="form-label">Profil Resmi (isteğe bağlı)</label>
        <input asp-for="ImageUrl" type="file" class="form-control" id="ImageUrlInput" accept="image/*" />
        <span asp-validation-for="ImageUrl" class="text-danger"></span>

        <!-- Resim önizleme  -->
        <div class="mt-2">
            <img id="ImagePreview" src="#" alt="Resim Önizleme" style="max-width: 200px; max-height: 200px; display:none; border-radius: 6px; border: 1px solid #ccc;" />
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="Email" class="form-label"></label>
        <div class="input-group">
            <span class="input-group-text"><i class="mdi mdi-email"></i></span>
            <input asp-for="Email" class="form-control" />
        </div>
        <div class="form-text">
            Lütfen geçerli bir e-posta adresi giriniz. Kullanıcı bilgileri ve şifresi bu adrese gönderilecektir.
        </div>
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label for="RoleId" class="form-label">Rol Seçiniz</label>
        <select class="form-select" id="RoleId" name="RoleName" >
            <option value="">Seçiniz</option>
            @foreach (var role in RoleConsts.Roles)
            {
                <option value="@role">@role</option>
            }
        </select>
        <span asp-validation-for="RoleName" class="text-danger"></span>
        <span id="assignRoleError" class="text-danger" style="display:none;"></span>
    </div>
@*     <div class="mb-3">
        <label asp-for="Username" class="form-label">Kullanıcı Adı</label>
        <div class="input-group">
            <span class="input-group-text"><i class="mdi mdi-account-circle"></i></span>
            <input asp-for="Username" class="form-control" placeholder="örn: ad.soyad" />
        </div>
        <span asp-validation-for="Username" class="text-danger"></span>
    </div> *@

   @*  <div class="mb-3">
        <label asp-for="Password" class="form-label">Şifre</label>
        <div class="input-group">
            <span class="input-group-text"><i class="mdi mdi-lock"></i></span>
            <input asp-for="Password" type="password" class="form-control" />
        </div>
        <span asp-validation-for="Password" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ConfirmPassword" class="form-label">Şifre Tekrar</label>
        <div class="input-group">
            <span class="input-group-text"><i class="mdi mdi-lock-check"></i></span>
            <input asp-for="ConfirmPassword" type="password" class="form-control" />
        </div>
        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
    </div> *@
    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" class="btn btn-secondary" onclick="window.history.back();">
            <i class="mdi mdi-arrow-left-bold-circle"></i> Geri Dön
        </button>

        <button type="submit" class="btn btn-primary">
            <i class="mdi mdi-content-save"></i> Kaydet
        </button>
    </div>
   
</form>

@section Scripts {


    <script>
        document.getElementById('ImageUrlInput').addEventListener('change', function (event) {
            var input = event.target;
            var preview = document.getElementById('ImagePreview');

            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }

                reader.readAsDataURL(input.files[0]);
            } else {
                preview.src = '#';
                preview.style.display = 'none';
            }
        });

        //Kullanıcı silinmiş ise gösterilir
         $(document).ready(function () {
            const hasDeleted = '@TempData["HasDeletedUser"]' === 'True';
            if (!hasDeleted) return;

            const userId = '@TempData["DeletedUserId"]';

            Swal.fire({
                title: 'Silinmiş Kullanıcı Bulundu',
                text: 'Bu kullanıcı daha önce silinmiş. Geri yüklemek ister misiniz?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Evet, geri yükle',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (!result.isConfirmed) return;

                Swal.fire({
                    title: 'İşlem yapılıyor...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                fetch('@Url.Action("RestoreDeletedUser", "UserManagement")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userId)
                })
                .then(r => r.json())
                .then(res => {
                    Swal.close();
                    if (res.status === 'ok') {
                                Swal.fire('Başarılı!', res.message, 'success').then(() => {window.location.href = '/UserManagement/Index';});
                    } else {
                        Swal.fire('Hata!', res.message || 'İşlem başarısız.', 'error');
                    }
                })
                .catch(() => {
                    Swal.close();
                    Swal.fire('Hata!', 'Sunucuya bağlanılamadı.', 'error');
                });
            });
        });
              
    </script>
}
