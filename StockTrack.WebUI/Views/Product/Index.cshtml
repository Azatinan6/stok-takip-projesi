@model IEnumerable<ResultProductDto>

@{
    ViewData["Title"] = "Ürün Yönetimi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h4 class="mb-3">Ürün Yönetimi</h4>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Html.Raw(TempData["ErrorMessage"])
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
    </div>
}

<div class="table-responsive">
    <table id="DataTables" class="table table-striped table-hover align-middle w-100">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Kategori</th>
                <th>Model</th>
                <th>Ad</th>
                <th>Resim</th>
                <th>Açıklama</th>
                <th>Uyarı Seviyesi</th>
                <th>Oluşturulma</th>
                <th>Aktif mi?</th>
                @if (User.IsInRole(RoleConsts.Admin))
                {
                    <th>Depo Detayı</th>
                    <th>İşlemler</th>
                }
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>#</th>
                <th>Kategori</th>
                <th>Model</th>
                <th>Ad</th>
                <th></th>
                <th>Açıklama</th>
                <th>Uyarı Seviyesi</th>
                <th>Oluşturulma</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
        <tbody>
            @{
                var row = 1;
            }
            @foreach (var p in Model)
            {
                var isActive = p.IsActive;

                <tr>
                    <td>@(row++)</td>
                    <td>@p.CategoryName</td>
                    <td>@p.Model</td>
                    <td>@p.Name</td>
                    <td>
                        @if (!string.IsNullOrEmpty(p.PhotoUrl))
                        {
                            <img src="/productimages/@p.PhotoUrl"
                                 alt="@p.Name"
                                 class="img-fluid img-thumbnail"
                                 style="max-height:80px; cursor:pointer"
                                 data-bs-toggle="modal"
                                 data-bs-target="#imageModal"
                                 data-img-url="/productimages/@p.PhotoUrl"
                                 data-img-alt="@p.Name" />
                        }

                    </td>
                    <td>
                        <span>@p.Description</span>

                    </td>
                    <td>
                        <span class="badge bg-warning text-dark">@p.WarningThreshold</span>

                    </td>
                    <td>@p.CreatedDate.ToString("dd MMMM yyyy")</td>
                    <td>
                        <span class="badge @(isActive ? "bg-success" : "bg-danger")">
                            @(isActive ? "Evet" : "Hayır")
                        </span>
                    </td>

                    @if (User.IsInRole(RoleConsts.Admin))
                    {
                      <td>
                            <a href="#" class="btn btn-sm btn-info stock-detail-btn"
                               data-bs-toggle="modal"
                               data-bs-target="#stockDetailModal"
                               data-product-id="@p.Id"
                               data-product-name="@p.Name"
                               data-category-name="@p.CategoryName">
                                Detay
                            </a>
                        </td>                  
                        
                        <td>
                            <div class="dropdown">
                                <a class="text-muted dropdown-toggle " href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded fs-4"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item edit-product-btn"
                                           href="#"
                                           data-bs-toggle="modal"
                                           data-bs-target="#editProductModal"
                                           data-product-id="@p.Id"
                                           data-product-name="@p.Name"
                                           data-product-model="@p.Model"
                                           data-product-warningthreshold="@p.WarningThreshold"
                                           data-product-categoryid="@p.CategoryId"
                                           data-product-description="@p.Description"
                                           data-product-photourl="@p.PhotoUrl">
                                            <i class="mdi mdi-pencil"></i> Düzenle
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item toggle-product-btn"
                                           href="#"
                                           data-url="@Url.Action(isActive ? "Deactivate" : "Activate", "Product", new { Id = p.Id })"
                                           data-product-name="@p.Name"
                                           data-action="@(isActive ? "deactivate" : "activate")">
                                            <i class="mdi mdi-check-circle-outline"></i> @(isActive ? "Pasif Yap" : "Aktif Yap")
                                        </a>
                                    </li>

                                    <li>
                                        <a class="dropdown-item delete-product-btn"
                                           href="#"
                                           data-url="@Url.Action("DeleteProduct", "Product", new { id = p.Id })"
                                           data-product-name="@p.Name">
                                            <i class="mdi mdi-delete"></i> Sil
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    }
                </tr>
            }
        </tbody>

     

    </table>
</div>

<!-- Resim Önizleme Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid rounded" style="max-height:70vh;" />
            </div>
        </div>
    </div>
</div>

@if (User.IsInRole(RoleConsts.Admin))
{
    <!-- Yeni Ürün Ekle Butonu -->
    <div class="d-flex justify-content-end align-items-center mt-4">
        <a asp-controller="Product" asp-action="Deleted" class="btn btn-outline-danger me-2 shadow-sm">
            <i class="mdi mdi-delete-restore"></i> Silinen Ürünler
        </a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
            <i class="mdi mdi-plus-circle"></i> Yeni Ürün Ekle
        </button>
    </div>

    <!-- Ürün Ekle Modal -->
    <div class="modal fade" id="createProductModal" tabindex="-1" aria-labelledby="createProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Create" asp-controller="Product" enctype="multipart/form-data" method="post">
                    @Html.AntiForgeryToken()
                    <div class="modal-header">
                        <h5 class="modal-title" id="createProductModalLabel">Yeni Ürün Ekle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Kategori <span class="text-danger">*</span></label>
                            <select name="CategoryId" class="form-select" asp-items="(IEnumerable<SelectListItem>)ViewBag.Categories" required>
                                <option value="">-- Kategori Seçiniz --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Model</label>
                            <input name="Model" class="form-control" maxlength="100" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ürün Adı <span class="text-danger">*</span></label>
                            <input name="Name" class="form-control" maxlength="150" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Uyarı Seviyesi</label>
                            <input id="createWarningThreshold" name="WarningThreshold" type="number" min="0" max="1000" class="form-control" />
                            <small class="text-muted">Stok bu seviyenin altına düşerse uyarı verilir.</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Açıklama</label>
                            <textarea name="Description" class="form-control" rows="3" maxlength="1000"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Fotoğraf Yükle</label>
                            <input type="file" name="PhotoUrl" class="form-control" id="createPhotoInput" accept=".jpg, .jpeg, .png" />
                            <div id="createPhotoPreviewContainer" style="display:none; position:relative; margin-top:10px;">
                                <img id="createPhotoPreview" class="img-fluid" style="max-height:150px;" />
                                <button type="button" id="removeCreatePhoto"
                                        class="btn btn-sm btn-danger rounded-circle"
                                        style="position:absolute; top:5px; right:5px; width:28px; height:28px;">
                                    ×
                                </button>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Ürün Düzenle Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Edit" asp-controller="Product" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="modal-header">
                        <h5 class="modal-title" id="editProductModalLabel">Ürünü Düzenle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="Id" />
                        <input type="hidden" name="IsPhotoRemoved" id="IsPhotoRemoved" value="false" />

                        <div class="mb-3">
                            <label class="form-label">Kategori <span class="text-danger">*</span></label>
                            <select name="CategoryId" class="form-select" asp-items="(IEnumerable<SelectListItem>)ViewBag.Categories" required>
                                <option value="">-- Kategori Seçiniz --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Model</label>
                            <input name="Model" class="form-control" maxlength="100" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ürün Adı <span class="text-danger">*</span></label>
                            <input name="Name" class="form-control" maxlength="150" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Uyarı Seviyesi</label>
                            <input id="editWarningThreshold" name="WarningThreshold" type="number" min="0" max="100000" class="form-control" />
                            <small class="text-muted">Stok bu seviyenin altına düşerse uyarı verilir.</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Açıklama</label>
                            <textarea name="Description" class="form-control" rows="3" maxlength="1000"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Yeni Fotoğraf Yükle</label>
                            <input type="file" id="photoInput" name="PhotoFile" class="form-control" accept=".jpg, .jpeg, .png" />
                            <div id="currentPhotoContainer" style="position:relative; display:inline-block; margin-top:10px;">
                                <img id="currentPhoto" src="" alt="Ürün Fotoğrafı" class="img-fluid mb-2" style="max-height:150px; display:none;" />
                                <button type="button" id="removeCurrentPhoto"
                                        class="btn btn-sm btn-danger rounded-circle"
                                        style="position:absolute; top:5px; right:5px; width:28px; height:28px; display:none;">
                                    ×
                                </button>
                            </div>
                            <div id="newPhotoPreviewContainer" style="display:none; position:relative; margin-top:10px;">
                                <img id="newPhotoPreview" class="img-fluid" style="max-height:150px;" />
                                <button type="button" id="removeNewPhoto"
                                        class="btn btn-sm btn-danger rounded-circle"
                                        style="position:absolute; top:5px; right:5px; width:28px; height:28px;">
                                    ×
                                </button>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hangi depoda kaç adet ürün var Modal -->
    <div class="modal fade" id="productStockDetailModal" tabindex="-1" aria-labelledby="productStockDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productStockDetailModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Kategori:</strong> <span id="modal-category-name"></span></p>
                    <hr />
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Depo</th>
                                <th>Toplam Stok</th>
                                <th>Dağıtılan</th>
                                <th>Kalan</th>
                            </tr>
                        </thead>
                        <tbody id="stock-detail-table-body">
                            <tr><td colspan="4" class="text-center text-muted">Veriler yükleniyor...</td></tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th class="text-end">TOPLAM:</th>
                                <th id="modal-total-stock">0</th>
                                <th id="modal-total-distributed">0</th>
                                <th id="modal-total-remaining">0</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {

    <script>
        // Resim modal
        $('#imageModal').on('show.bs.modal', function (event) {
            const img = $(event.relatedTarget);
            $('#modalImage').attr('src', img.data('img-url')).attr('alt', img.data('img-alt'));
        });



        // Aktif/Pasif
        $(document).on('click', '.toggle-product-btn', function (e) {
            e.preventDefault();
            const $btn = $(this);
            const url = $btn.data('url');
            const name = $btn.data('product-name');
            const isDeactivate = $btn.data('action') === 'deactivate';

            Swal.fire({
                title: isDeactivate ? `${name} pasif hale getirilecek.` : `${name} aktif hale getirilecek.`,
                text: 'Devam etmek istediğinize emin misiniz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: isDeactivate ? 'Evet, pasif yap' : 'Evet, aktif yap',
                cancelButtonText: 'Hayır'
            }).then((r) => {
                if (!r.isConfirmed) return;
                $btn.prop('disabled', true);
                Swal.fire({ title:'Lütfen bekleyin', allowOutsideClick:false, didOpen:()=>Swal.showLoading(), showConfirmButton:false });

                $.ajax({
                    type: 'POST',
                    url: url,
                })
                .always(() => Swal.close())
                .done((data) => {
                    Swal.fire({ icon: data.success ? 'success' : 'error', title: data.success ? 'Başarılı' : 'Hata', text: data.message })
                        .then(() => { if (data.success) location.reload(); else $btn.prop('disabled', false); });
                })
                .fail((xhr) => {
                    const resp = xhr.responseJSON || {};
                    Swal.fire('Hata', resp.message || 'Beklenmeyen hata.', 'error');
                    $btn.prop('disabled', false);
                });
            });
        });

        // Sil
        $(document).on('click', '.delete-product-btn', function (e) {
            e.preventDefault();
            const $btn = $(this);
            const name = $btn.data('product-name');
            const url = $btn.data('url');

            Swal.fire({
                title: 'Emin misiniz?',
                text: `"${name}" silinecek. Devam edilsin mi?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, sil',
                cancelButtonText: 'İptal'
            }).then((r) => {
                if (!r.isConfirmed) return;
                $btn.prop('disabled', true);
                Swal.fire({ title:'Siliniyor...', allowOutsideClick:false, didOpen:()=>Swal.showLoading(), showConfirmButton:false });

                $.ajax({
                    type: 'POST',
                    url: url,

                })
                .always(() => Swal.close())
                .done((data) => Swal.fire('Silindi', data.message, 'success').then(() => location.reload()))
                .fail(() => {
                    Swal.fire('Hata', 'Silme işlemi başarısız oldu.', 'error');
                    $btn.prop('disabled', false);
                });
            });
        });

        //  foto önizleme
        $('#createPhotoInput').on('change', function () {
            const file = this.files?.[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    $('#createPhotoPreview').attr('src', e.target.result);
                    $('#createPhotoPreviewContainer').show();
                };
                reader.readAsDataURL(file);
            }
        });
        $('#removeCreatePhoto').on('click', function () {
            $('#createPhotoInput').val('');
            $('#createPhotoPreview').attr('src', '');
            $('#createPhotoPreviewContainer').hide();
        });

        // güncellemede: foto yönetimi
        let originalSrc = "";
        $('#editProductModal').on('show.bs.modal', function (event) {
            const btn = $(event.relatedTarget);
            const id   = btn.data('product-id');
            const name = btn.data('product-name');
            const model= btn.data('product-model');
            const warning = btn.data('product-warningthreshold');
            const categoryId = btn.data('product-categoryid');
            const description = btn.data('product-description');
            const photoUrl = btn.data('product-photourl');

            const $m = $(this);
            $m.find('input[name="Id"]').val(id);
            $m.find('input[name="Name"]').val(name || '');
            $m.find('input[name="Model"]').val(model || '');
            $m.find('select[name="CategoryId"]').val(categoryId);
            $m.find('textarea[name="Description"]').val(description || '');
            $m.find('input[name="WarningThreshold"]').val(warning ?? '');

            const imagePath = photoUrl ? ("/productimages/" + photoUrl) : "";
            originalSrc = imagePath;
            if (imagePath) {
                $('#currentPhoto').attr('src', imagePath).show();
                $('#removeCurrentPhoto').show();
            } else {
                $('#currentPhoto').hide();
                $('#removeCurrentPhoto').hide();
            }
            $('#IsPhotoRemoved').val('false');
            $('#photoInput').val('');
            $('#newPhotoPreviewContainer').hide();
            $('#newPhotoPreview').attr('src','');
        });

        $('#photoInput').on('change', function () {
            const file = this.files?.[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    $('#newPhotoPreview').attr('src', e.target.result);
                    $('#newPhotoPreviewContainer').show();
                    $('#currentPhoto').hide();
                    $('#removeCurrentPhoto').hide();
                    $('#IsPhotoRemoved').val('false');
                };
                reader.readAsDataURL(file);
            }
        });

        $('#removeNewPhoto').on('click', function () {
            $('#photoInput').val('');
            $('#newPhotoPreview').attr('src','');
            $('#newPhotoPreviewContainer').hide();
            if (originalSrc) {
                $('#currentPhoto').attr('src', originalSrc).show();
                $('#removeCurrentPhoto').show();
                $('#IsPhotoRemoved').val('false');
            }
        });

        $('#removeCurrentPhoto').on('click', function () {
            originalSrc = "";
            $('#currentPhoto').attr('src','').hide();
            $(this).hide();
            $('#IsPhotoRemoved').val('true');
        });


        // Eğer silinmiş ürün varsa uyarı göster
        @if (TempData["HasDeletedProducts"] != null && (bool)TempData["HasDeletedProducts"])
        {
            var deletedName = TempData["DeletedProductName"]?.ToString() ?? "";
            var deletedId = TempData["DeletedProductId"]?.ToString() ?? "";

            <text>
                        Swal.fire({
                            title: 'Bu Ürün Daha Önce Silinmiş',
                            html: '<p>@deletedName</p>',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Geri Yükle',
                            cancelButtonText: 'Vazgeç'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                    type: 'POST',
                                    url: '@Url.Action("RestoreDeletedProduct", "Product")',
                                    contentType: 'application/json; charset=utf-8',
                                    data: JSON.stringify(parseInt('@deletedId')),
                                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }
                                })
                                .done((data) => {
                                    Swal.fire('Başarılı', data.message, 'success')
                                        .then(()=> location.reload());
                                })
                                .fail(() => {
                                    Swal.fire('Hata', 'Geri yükleme başarısız oldu.', 'error');
                                });
                            }
                        });
            </text>
        }


        //ürün depoda kaç adet var modalı
        $(document).on('click', '.stock-detail-btn', function() {
            const productId = $(this).data('product-id');
            const productName = $(this).data('product-name');
            const categoryName = $(this).data('category-name');

            // Modal başlığını ve ürün bilgilerini doldur
            $('#productStockDetailModalLabel').text(`${productName} Depo Stok Durumu`);
            $('#modal-category-name').text(categoryName);

            // Yükleniyor animasyonunu göster
            const $tableBody = $('#stock-detail-table-body');
            $tableBody.html('<tr><td colspan="4" class="text-center text-muted">Veriler yükleniyor...</td></tr>');

            $.ajax({
                url: '/Product/GetProductStockDetails',
                type: 'GET',
                dataType: 'json',
                data: { productId: productId },
                success: function(response) {
                    $tableBody.empty(); // Yükleniyor mesajını temizle

                    if (!response || response.length === 0) {
                        $tableBody.append('<tr><td colspan="4" class="text-center text-muted">Bu ürüne ait stok kaydı bulunamadı.</td></tr>');
                    } else {
                        response.forEach(function(item) {
                            const row = `
                                <tr>
                                    <td>${item.mainRepoName}</td>
                                    <td><span class="badge bg-secondary">${item.totalQuantity}</span></td>
                                    <td><span class="badge bg-primary">${item.distributedQuantity}</span></td>
                                    <td><span class="badge ${item.remainingQuantity <= 0 ? 'bg-danger' : 'bg-success'}">${item.remainingQuantity}</span></td>
                                </tr>
                            `;
                            $tableBody.append(row);
                        });

                        calculateAndSetTotals(response); //toplamarı hesaplayan fonksiyon
                    }
                },
                error: function(xhr, status, error) {
                    $tableBody.html('<tr><td colspan="4" class="text-center text-danger">Veriler yüklenirken bir hata oluştu.</td></tr>');
                    console.error('AJAX Error:', error);
                }
            });

            // Modalı göster
            $('#productStockDetailModal').modal('show');
        });

        // Toplamları hesaplayan fonksiyon
        function calculateAndSetTotals(data) {
                 // Toplamları sıfırla
        $('#modal-total-stock').text(0);
        $('#modal-total-distributed').text(0);
        $('#modal-total-remaining').text(0);
            let totalStock = 0, totalDistributed = 0, totalRemaining = 0;

            data.forEach(function (item) {
                totalStock += item.totalQuantity;
                totalDistributed += item.distributedQuantity;
                totalRemaining += item.remainingQuantity;
            });

            // Footera yaz
            $('#modal-total-stock').text(totalStock);
            $('#modal-total-distributed').text(totalDistributed);
            $('#modal-total-remaining').text(totalRemaining);
        }


    </script>
}
