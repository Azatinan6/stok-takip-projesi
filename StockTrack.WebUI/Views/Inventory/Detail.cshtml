@using StockTrack.Dto.Inventory
@model InventoryDetailDto

@{
    ViewData["Title"] = "Ürün Stok Detayları";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="card shadow-sm border-0 mb-4 bg-primary text-white">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-1 text-white">@Model.Brand @Model.Model</h4>
            <p class="mb-0 opacity-75">Ürün Adı: @Model.ProductName</p>
        </div>
        <div>
            @if (Model.IsArcBox)
            {
                <span class="badge bg-warning text-dark fs-6"><i class="mdi mdi-star"></i> Özel Seri No Takipli (Arc Box)</span>
            }
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">

        <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#tab-stock" role="tab">
                    <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                    <span class="d-none d-sm-block"><i class="mdi mdi-cube-outline me-1"></i> Stok Durumu</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-inbound" role="tab">
                    <span class="d-block d-sm-none"><i class="far fa-user"></i></span>
                    <span class="d-none d-sm-block text-success"><i class="mdi mdi-arrow-bottom-left-bold-outline me-1"></i> Giriş Hareketleri</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-outbound" role="tab">
                    <span class="d-block d-sm-none"><i class="far fa-envelope"></i></span>
                    <span class="d-none d-sm-block text-danger"><i class="mdi mdi-arrow-top-right-bold-outline me-1"></i> Çıkış Hareketleri</span>
                </a>
            </li>
        </ul>

        <div class="tab-content p-3 text-muted">

            <div class="tab-pane active" id="tab-stock" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-dark">Güncel Stok Dağılımı</h5>
                </div>

                @if (Model.IsArcBox)
                {
                    <div class="alert alert-info border-0 shadow-sm">
                        <i class="mdi mdi-information me-2"></i> Bu ürün bir <strong>Arc Box</strong> olduğu için her bir cihazın Seri Numarası (SN) ve MAC adresi ayrı satırlarda takip edilmektedir.
                    </div>
                    <p><em>(Arc Box Seri No Tablosu Buraya Gelecek...)</em></p>
                }
                else
                {
                    <p><em>(Normal Ürün Depo Dağılım Tablosu Buraya Gelecek...)</em></p>
                }
            </div>

            <div class="tab-content p-3 text-muted">

                <div class="tab-pane active" id="tab-stock" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-dark">Güncel Stok Durumu</h5>
                    </div>

                    @if (Model.IsArcBox)
                    {
                        <div class="alert alert-info border-0 shadow-sm">
                            <i class="mdi mdi-information me-2"></i> Bu ürün bir <strong>Arc Box</strong> olduğu için her bir cihazın Seri Numarası (SN) ve MAC adresi takip edilmektedir. Toplam: @Model.CurrentStock Adet
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover mt-3">
                                <thead class="table-light">
                                    <tr>
                                        <th>Seri Numarası (SN)</th>
                                        <th>ETH MAC</th>
                                        <th>WLAN MAC</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.SerialNumbers)
                                    {
                                        <tr>
                                            <td class="fw-bold text-primary">@item.SerialNumber</td>
                                            <td>@item.EthMac</td>
                                            <td>@item.WlanMac</td>
                                        </tr>
                                    }
                                    @if (!Model.SerialNumbers.Any())
                                    {
                                        <tr><td colspan="3" class="text-center text-muted">Henüz seri numarası eklenmemiş.</td></tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="mdi mdi-cube text-primary" style="font-size: 4rem;"></i>
                            <h2 class="display-4 fw-bold text-dark mt-2">@Model.CurrentStock</h2>
                            <p class="text-muted fs-5">Depoda Bulunan Toplam Adet</p>
                        </div>
                    }
                </div>

                <div class="tab-pane" id="tab-inbound" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-dark">Stok Giriş Geçmişi</h5>
                        <button class="btn btn-success btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#modalInbound">
                            <i class="mdi mdi-plus"></i> Stok Arttır (Giriş Yap)
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="bg-success text-white">
                                <tr>
                                    <th>Tarih</th>
                                    <th>İşlem Türü ID</th>
                                    <th>Adet</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.InboundMovements)
                                {
                                    <tr>
                                        <td>@item.Date.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>@item.MovementStatusId</td>
                                        <td class="text-success fw-bold">+@item.Quantity</td>
                                        <td>@item.Description</td>
                                    </tr>
                                }
                                @if (!Model.InboundMovements.Any())
                                {
                                    <tr><td colspan="4" class="text-center">Kayıtlı giriş hareketi bulunamadı.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane" id="tab-outbound" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-dark">Stok Çıkış Geçmişi</h5>
                        <button class="btn btn-danger btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#modalOutbound">
                            <i class="mdi mdi-minus"></i> Stok Azalt (Çıkış Yap)
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="bg-danger text-white">
                                <tr>
                                    <th>Tarih</th>
                                    <th>İşlem Türü ID</th>
                                    <th>Adet</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OutboundMovements)
                                {
                                    <tr>
                                        <td>@item.Date.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>@item.MovementStatusId</td>
                                        <td class="text-danger fw-bold">-@item.Quantity</td>
                                        <td>@item.Description</td>
                                    </tr>
                                }
                                @if (!Model.OutboundMovements.Any())
                                {
                                    <tr><td colspan="4" class="text-center">Kayıtlı çıkış hareketi bulunamadı.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

    </div>
</div>
<div class="modal fade" id="modalInbound" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title text-white"><i class="mdi mdi-plus-circle me-2"></i> Stok Girişi Yap</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formInbound" action="/Inventory/AddStock" method="post">
                    <input type="hidden" name="ProductId" value="@Model.ProductId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">İşlem Türü / Giriş Nedeni</label>
                        <select class="form-select" name="MovementStatusId" required>
                            <option value="">-- Seçiniz (Örn: Merkezden Geldi, İade vb.) --</option>
                            <option value="1">Merkez Depodan Kargo</option>
                            <option value="2">Hastaneden İade</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">Eklenecek Adet</label>
                            <input type="number" class="form-control text-success fw-bold" name="Quantity" min="1" value="1" required />
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold">Ürün Durumu</label>
                            <select class="form-select" name="ProductStatusId" required>
                                <option value="1">Yeni</option>
                                <option value="2">Kullanılmış</option>
                                <option value="3">Arızalı</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Açıklama / Not</label>
                        <textarea class="form-control" name="Description" rows="2" placeholder="İrsaliye no veya özel notlar..."></textarea>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-success"><i class="mdi mdi-check"></i> Stoğa Ekle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalOutbound" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title text-white"><i class="mdi mdi-minus-circle me-2"></i> Stok Çıkışı Yap</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formOutbound" action="/Inventory/RemoveStock" method="post">
                    <input type="hidden" name="ProductId" value="@Model.ProductId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">İşlem Türü / Çıkış Nedeni</label>
                        <select class="form-select" name="MovementStatusId" required>
                            <option value="">-- Seçiniz (Örn: Kurulum, Kargo vb.) --</option>
                            <option value="3">Hastaneye Kargo</option>
                            <option value="4">Kurulum İçin Çıkış</option>
                            <option value="5">Zayiat / Çöpe Ayrıldı</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold text-danger">Düşülecek Adet</label>
                            <input type="number" class="form-control text-danger fw-bold" name="Quantity" min="1" value="1" required />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Açıklama / Not</label>
                        <textarea class="form-control" name="Description" rows="2" placeholder="Hangi hastane veya proje için..."></textarea>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-danger"><i class="mdi mdi-check"></i> Stoktan Düş</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>